<!DOCTYPE html>
<html lang="en-us">
<head>
    <base href="https://cdn.jsdelivr.net/gh/web-ports/hollow-knight@main/">
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hollow Knight Web</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes" />
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background: #231F20;
            font-family: cursive;
        }
        #unity-container {
            width: 100%; height: 100%; position: fixed; top: 0; left: 0;
            display: none;
        }
        #unity-canvas {
            width: 100%; height: 100%; background: #231F20;
            display: none;
        }
        #loading-text {
            color: white; font-size: 48px; text-align: center; margin-top: 40px;
        }
        #unity-loading-bar {
            width: 60%; margin: 20px auto; height: 20px;
            background: #555; border-radius: 10px; overflow: hidden;
        }
        #unity-progress-bar-full {
            height: 100%; width: 0%; background: #4caf50;
            transition: width 0.2s;
        }
        #unity-mobile-warning {
            color: white; text-align: center; margin-top: 20px;
            display: none;
        }
        #error-message {
            color: #f44336; /* red */
            text-align: center;
            margin-top: 20px;
            font-size: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading-text" aria-live="polite">LOADING...</div>
    <div id="unity-loading-bar">
        <div id="unity-progress-bar-full"></div>
    </div>

    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
        <div id="unity-mobile-warning">WebGL builds are not supported on mobile devices.</div>
    </div>

    <div id="error-message"></div>

    <script>
        const loadingText = document.getElementById("loading-text");
        const progressBarFull = document.getElementById("unity-progress-bar-full");
        const errorMessage = document.getElementById("error-message");

        let totalBytes = 0;
        let loadedBytes = 0;

        async function getSize(url) {
            try {
                const res = await fetch(url, { method: "HEAD", cache: "no-store" });
                return parseInt(res.headers.get("Content-Length") || "0", 10);
            } catch (err) {
                console.error("HEAD request failed for:", url, err);
                return 0;
            }
        }

        async function fetchWithProgress(url) {
            try {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ${response.status} on ${url}`);
                const reader = response.body.getReader();
                const chunks = [];
                let received = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    received += value.length;
                    loadedBytes += value.length;
                    chunks.push(value);

                    const mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
                    const mbTotal = (totalBytes / (1024 * 1024)).toFixed(2);
                    loadingText.textContent = `LOADING... ${mbDone} MB / ${mbTotal} MB`;

                    const progress = loadedBytes / totalBytes;
                    progressBarFull.style.width = `${(progress * 100).toFixed(2)}%`;
                }

                // Combine chunks into one Uint8Array buffer
                const fullBuffer = new Uint8Array(received);
                let offset = 0;
                for (const chunk of chunks) {
                    fullBuffer.set(chunk, offset);
                    offset += chunk.length;
                }
                return fullBuffer.buffer;
            } catch (error) {
                throw new Error(`Failed to fetch ${url}: ${error.message}`);
            }
        }

        async function mergeFiles(partFiles) {
            const buffers = await Promise.all(partFiles.map(fetchWithProgress));
            return URL.createObjectURL(new Blob(buffers));
        }

        function getParts(file, start, end) {
            return Array.from({length: end - start + 1}, (_, i) => `${file}.part${start + i}`);
        }

        (async () => {
            const dataParts = getParts("Build/bog.data", 1, 44);
            const wasmParts = getParts("Build/bog.wasm", 1, 2);
            const allParts = [...dataParts, ...wasmParts];

            try {
                const sizes = await Promise.all(allParts.map(getSize));
                totalBytes = sizes.reduce((a, b) => a + b, 0);

                const [dataUrl, wasmUrl] = await Promise.all([
                    mergeFiles(dataParts),
                    mergeFiles(wasmParts),
                ]);

                const buildUrl = "Build";
                const loaderUrl = `${buildUrl}/bog.loader.js`;

                const config = {
                    dataUrl,
                    frameworkUrl: `${buildUrl}/bog.framework.js`,
                    codeUrl: wasmUrl,
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "Team Cherry & Truffled",
                    productName: "Hollow Knight",
                    productVersion: "1.0",
                };

                const container = document.getElementById("unity-container");
                const canvas = document.getElementById("unity-canvas");
                const mobileWarning = document.getElementById("unity-mobile-warning");

                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    container.className = "unity-mobile";
                    canvas.className = "unity-mobile";
                    mobileWarning.style.display = "block";
                    setTimeout(() => mobileWarning.style.display = "none", 5000);
                } else {
                    function resizeCanvas() {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                        canvas.style.width = `${window.innerWidth}px`;
                        canvas.style.height = `${window.innerHeight}px`;
                    }
                    resizeCanvas();
                    window.addEventListener("resize", resizeCanvas);
                }

                container.style.display = "block";

                const script = document.createElement("script");
                script.src = loaderUrl;
                script.onload = () => {
                    createUnityInstance(canvas, config, progress => {
                        progressBarFull.style.width = `${(progress * 100).toFixed(2)}%`;
                    }).then(() => {
                        loadingText.remove();
                        document.getElementById("unity-loading-bar").style.display = "none";
                        canvas.style.display = "block";
                    }).catch(err => {
                        errorMessage.textContent = "Error launching Unity: " + err;
                        errorMessage.style.display = "block";
                    });
                };
                script.onerror = () => {
                    errorMessage.textContent = "Failed to load Unity loader script.";
                    errorMessage.style.display = "block";
                };
                document.body.appendChild(script);

                // Failsafe timeout for loading issues
                setTimeout(() => {
                    if (!canvas.style.display || canvas.style.display === "none") {
                        errorMessage.textContent = "Game took too long to load. Please check your connection or try again.";
                        errorMessage.style.display = "block";
                    }
                }, 60000);

            } catch (err) {
                console.error(err);
                errorMessage.textContent = "Failed during loading: " + err.message;
                errorMessage.style.display = "block";
            }
        })();
    </script>
</body>
</html>



